import {ethers as hEthers} from "hardhat";
import {loadFixture} from "@nomicfoundation/hardhat-network-helpers";
import {expect} from "chai";
import {ethers} from "ethers";

import {VotingTest__factory, HashNFT__factory} from "../../typechain-types";
import {signVote} from "../../lib/signers";

const fstAddress = "0x0E192d382a36De7011F795Acc4391Cd302003606";
const fstMappingSlot = 51;
const fstTotalSupplySlot = 53;

// block hash of ethereum at block height 16238432
const block = {
  baseFeePerGas: "0x24a254e05",
  difficulty: "0x0",
  extraData: "0x68747470733a2f2f6574682d6275696c6465722e636f6d",
  gasLimit: "0x1c9c380",
  gasUsed: "0x1ba52a5",
  hash: "0x99271e7993d68eefd1e5800a9567b974a34478c1628db83f6c2f968d8cf36fed",
  logsBloom:
    "0x1678591891983a2910886638e99d80621036500a4a8256f103e180484a86380098463360a40a00055741d909121a091932516b2a2e61aa0012888a1d16622000604250514740085ca86206c8f0904a718296908458c7b2548147cc0182426da51e8401020638807e901f9b20420688b1c9151d6089136d29e7859d90260c2096024043124012d15600ce3880019480272c830909810c0039486c6040455490acf23527cb9366e9039d4e10d08041860d01d20a64242c19c302c22a8613a0201e7764ec4a43032842f4808602184416b046510a4c1488095988ba0dc6120bb820a0fabc3d509040a0608c50d8219f0cc22716a17e783150d8400b3956650b3031",
  miner: "0xfeebabe6b0418ec13b30aadf129f5dcdd4f70cea",
  mixHash: "0x1155a20ff37da0fea707f8b00ef286fc12cf8c7c35061f852aa7d177e73c5cf0",
  nonce: "0x0000000000000000",
  number: "0xf7c760",
  parentHash: "0xc659c3240279749d5c1a8c40e97ecbb5cbeb42ba22d575eed8f575db7f78d269",
  receiptsRoot: "0xfbacaa34581d27f5a517ebd9e6b92651a373ac8c943e56d08e432f49a690654d",
  sha3Uncles: "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
  size: "0x5448",
  stateRoot: "0x15590aa96861623d646dfc79ca49b823db411915ae181ff600b27236848c80d8",
  timestamp: "0x63a3f823",
  totalDifficulty: "0xc70d815d562d3cfa955",
  transactions: [],
  transactionsRoot: "0x111e69c1c71917117f77c4adc8b319b9f1f4a007b9b3d65f43f80afd99e9470b",
  uncles: [],
};

const proofs = {
  accountProof: [
    "0xf90211a01d97b8b35d6d4e87f31ff34e6f9925df4cba99476d47145b21d9a790ef7525d9a08370d24b78ecfb52e170c5c44aed44ad4c2c77c7c78a53c48f59b7369236261da0c4d4a9446daef3e5e26d478510b8ea291d5a239645b2e4e34922638cb34d9817a04b593f54b8f1135d81b92b16c911f4f899873e831b999e92045fb2cbbd541606a0036d5da3802e3347b1a721f759c92fb30b07786d5669c6292a2c0532037ac595a0f0b9c0516db3ca1ab9ba2a197bfae03ab64b5f69869fe762fff3aa54ba3a5611a08cf1422278885dc507d229efe539af1a246fb7ce2c858e545a083fa48e8f2571a05c07f37c3450b8908698147beb549b0ab1761a4c66df740730400893c942bf1aa02dd751609ace7a769858ab409be84e4176a75590b059b6e51664ce5613b4bd41a0b4885e2274ffd704384d59bf944ae66ce9aa1838af91d0d2e957c354a5bacc6da0a74ee4472ffa7ebbb00116a13fea7e53497a3428c6cad482e4e64de0cb5b699ea0646704b0fbeb5928a13a4269710775c192c0ef00b625a793e32d21444e306a82a020a351134f4effb167b9108e1970eaa51d4398b9618d3a2ae071ebd8505c64a4a0ee8a308f4aef59af9d65195004a0b49c68c26808ce7f34b489987602ae041485a0c4c7d60fff81dfc9caffae62c2ed677e97373ae68ba3fe50b209db9fa485a377a0d6bdff8970898577a3a2a9e0f58a98074af41ac922a260b0b95ea4d6f495fca580",
    "0xf90211a0d201cf85b3ecfeee5f19d15bce734b9778dc5280c4d1b7bf8dda9b3ff2ef322ca0b895cb65defb890d90ebdad54866b59be834f25d9c5d106a3596bb2b9062a80da04fae7051fd15a594ae5a7b84c4a5b8790a304c36a125be6f1a4be25367285f78a064d1c7d8bab14fa07a373651a41d6e3f87b58fe6244f4cbb79649bd29647943aa03a714f890eb7206fa9784b77753c2afbb58b6654159f8fe17ba40f031b1c09f4a08473569d153d1531933e0f7227583ab715704da2f7ce158d99e876a79655766fa0ec754389e4135b2922ca59c7d1223b8d4fb9e437e6dd6d8b6094575656bd288ea0a295d68aa8b38a28454d5ac1cde4fd9fbbf119bdbc527796cc5610741fda55caa0d04fc50216214b435aedd85bcf0329ef15105683a760cf80f9fe69c35352504ba0c4a1a1526f2086caddb0cc6efa3d0553978ef88dc14c361607e0ad126a0b5740a08d5a3d78ca16edf486a3d47ea01eb4ff5c509049d1e734bc5a89455244763a8ca0d525d06e3182354768c95f017b426cc968877bc8b4e221f1e7095b08587599eea0a2276f0ac4438fb191358e316a08f64b41dccfb86624a4f7c777436017f3a1d3a000239d500dae93e2d7aae9824d876b9a17c37bb12f882cbee7b927f1d774e171a0b50063fbe105b45381e74ecda35a165968390e8a2f5aedcea165237a44724403a05d657f5919f650926885d611c6259c56c0c9b8d5cb7dd86f2a45c1866e03a6f180",
    "0xf90211a07596e9c778f21cf5805f5985cf5dc00e63e5f47377d5a75fcabfa57521d3648fa0835acc0c95fab01451307d304846f6a8f565a4305cc15bf66c89f2f03e314ad8a0e4edcdebb9c1d8c1897fe1ab6a3f5cf52efcf518e639a39c6499e97f28ed9268a0a6549c785bff61c81746601a23c84722e5c76942a0c0fac2b1eb3e68b703326fa08cabf400b16ed1420ce20d1ae86e309415a2afda925e92d8f9184e4f166cdc66a05f92c9a107629a03bebe495cbfaf29a8e4e5672028aa30eb0a0b113e4bc4b05fa02716dac1156a2f43c239ae944aee06cef131d717c25a9bdacd50c91387df013fa0de8c39590136e4468f268d67a27ee3932f8316240d1773fa0d791f438b17ffd7a0eab3d251d9e83e837bfa7a607fd2e5024a69598f1c22372fe3315570ceab7baba08f54f1a4c67d62ad50481618be32d3e74e4c89dcbe32b3228d3562dc7ebf133ea0b44ce9e602aa7e70529eff88a05971bd818766f258f415367fe14934dfaf277ea0b2508b4c92d21d23bc8d50d52e5de0f6d291b0061ddf9efb809d23a7796b2ae2a082a7ced9f4ad2ae318d6d22d673f9a757a15a41a7aa768cdf3b0a8465a6ca5efa0669fedae602363f7b455cbf83bcfe41a545c90762226c50559c50fee7a754aeaa0fa800eedacbf7a98582f68b5cca90942cd6578f773dfa24a3cb07f1fa639f675a0c43e0a71f7d71addd1f4e589fe37d38da4afc226d66646b187dab98568f336ab80",
    "0xf90211a080860cb92907a45982ff72db1e53955080dc196359519ee2e33b36ebfadaf801a020c3a118c6f1fda93d3d8b5dc0fe4d4fbbc0ee532755b32ce9b78cbc3eaf55c6a0df4857b3fff27f798a75d76948f6f71b06d3675bec4b312b2d70f864aaee7a3aa094d22723b7e5ccab0bd5e53ec0d9f296bcba129a9f1b78aa86f4812da45de314a0a93ed218529235e3d1ec1f7163908d1fab662e6e11c92ebe8bdd5a411b0c2105a0c175c57f754ceeeedfacba4f5d5ee7582cbe1b1c0815a22cdd5daaf6f30d510ba0158936f33b8d727ac916aef51c6e788484eed988c80099468ebcf69821ed6340a0aa52eb6c352a3a259c638ea50a585905feec6e1e4c469891cccf2d5df5021c06a028c4b519d9dba596aa0c32ca65f6a31093bdf215402da5f2b2f5f4d07a4ba9c8a0ecbde8d3d6be7f535c946c90c9366bb62a489257dfe6ed00477d1cf52c2d6ff2a0fb47241a8a3662183f21258117f406f2ec47c456a4a127953aea626b76a64885a047a70b1f2c0e80f48d7c4443e82a0442dc58b7da5537e970ad99833d6e6ecbfda03b4ccc6bb79982122ce030a69ddd359d573e08dc9c0e29d790eb18719c4a7dc9a07d5c1953bc39e5fe516b7f91fe8b77fac68145f0380481c46f9166da3db3f490a05783cb35643178331308a0a55e237a2f01f718891f8f14822a6ba599320a3c62a02cc029d313dd87346b1d8f90dd778d4076ed58ffe206b009033d1d281fc664d380",
    "0xf90211a098f67550fb04fadf9b413953e3349b866742af1ee4a2f96e87b9741723f4c545a00afebfa45c615fed94c5a95dcc44934ab77033ec6cc88f692909092db6a4fb76a083c6cfec5c864ed47961cfc44ca81730cfb8a24c172daf87b900ef7fc977b089a0e25765aa817954465bc400f65de4c48a3cbea8cd14ae493094c2e1b2d182d40aa09c8574eb47c6abee627db7f59c01e3c27e905b34b0b9d1c81ad8da35539b031fa049539304d66e9b89c71dc8c99093879ffc60afbb80d48fdc9807cc9fc9139768a0f1a558e05374eb5fcaaee7a43396f8956ed8c18c837bf7c2f8c078e5183b98dca03352dc8842b9d492e6bcd210b7a760d8205bbeff88720911cee8b0b680bed36ca0baec4053c768b114d406f47d8b80218e1540a4fa497721e7f0dd66510014e0aea0423039984072d17e32d0202d18eb9974eac677fbff8e270706013e25e6abfcd6a014571812024cad9e0d27529a538d72f41e465678c5de5155ce3034cfc980a2c4a0cfbb1a88023cd64698aa049c98680803d76a45393c76a86c181312b0db76dcd4a010a7db9099affdf346963d23749ee560470f3aa2dbd4b80645998ffedd8e49b2a05ba0c11c412dcd2ff76a21933fc3a1d712e37a323dd52c0d9acfe1d2f172cbb3a0d296dd7dcd685902b6bac7a9b1a8dc440ff2e9692d3bde17296ed9e48ce651bca02dce667a0180183c0b764c449482096107654130d81e13f0971930b8fea83fbb80",
    "0xf90211a09b0497a453a1643508226e2a266d06e66bc095163663ee64e2ff71a49ceedc6aa04a2101b0eacdc9117dafb7eb9b0e3565e4c803229ac9c97f9c44ff7de0fe25b9a0fda06dc3b344292fab5a642377091f955a12443bc6f17fcdf564f7ced3a6f026a068a9abf934ab5bde990e14a42d29bdc0dd37971ee863bb3cb982e265c9d6862ca0a979567757a20112373350dbe663ab01a84aab85fa20b93776d649a0f70da07fa0924817a441552eb83e0b8a71093129f86440953a7abf828b7a76e0fe57c064a3a08431efbfe459619902126169624da217122051195a1b15fb8f2b7708117f5dc0a0fb8493622d20905701e3d231b2cfa4e4281a3d552a13ee22e218e4d834feabfaa09da468343458475b83dfc8351e02178dcd2144da5ea24265a5f2751a5b4a144fa00310683cefc2f1714baa4f03b8d6eba789762a4825864d51244f19a2440b51e9a08f3a2fa27462f0e7a15f34fa0395aef55ab3edf91c7c90f78ae4c16982bb3f8fa06ca08176b60867f4c95d82d4c545027c6b872d0d428272edb0be21abbde512efa0a9500e9e8205b556080911fb42d33487dc0b6e8c37f95b0903b0aee374eabf2da0f845f2ff20101aa12bcb050763bb9d53163843167a94d2da4732b6a0a026891ca0e8d3baa76ae00b194a6d36ff32b6280d970c87e6c0ef3da6e929e6ff540049aea0c5013dbc643762da8e24d7068e4caceee5c89cf7e89c15c77924c993d0d4157880",
    "0xf9019180a0a2a3a43d7d3b6df68bfb49bcff374115da571768e614e57f486fa50aed67f5eea0c42cd5892d7192d6eea2816c5596b2eedbd0572d5a1fffc66acd1856ee232802a0ca4c108a7baec36e62e1990814992e691d1ec1ceba8942f23585d65d1f756834a0e9d4d7dbe3a34b52a3b3fc5deefe7c3995c94f39a809a2c9ae314d813124c755a00b7a420d34000458a3daa4ac7fad8eee72878d6e722eb206fe81e16e15d06d67a02992c50dfa2c98dad12ffc35ed287e8de0fb1448fec54d964befff8c8eb85744a0019340ba5b91aee65fce3767839ed8f2e81d6fa0673960508f0e275f327a3258a07e3c021c1a031cbb7d09b401e2b2e6240a25578437c2978f5db93473ad589416a0248cb00d886440d2a314b0ac2a86e0d349eae7215a3487d3486a145729770437a05941631da9a34c7fe51c412717572254e21309644b0fec8ec01cca4675e94d24a0f5f82236f4a3e85f4c55d30aec5b65666362bf43c1a4cfe623948d3c9a2d0ed78080a000ee543a4d6c110a257c988d674ace486163c369c585d2a9d06e647d36307ea38080",
    "0xf85180808080a06b317bd52e53aab4955b52f1faba883e056d05491bcd5d21726930cab96e390f80a0123215e6ff4800629ec7d999e1aa35c3cfc269bc140b9ca667d370e405b64b2680808080808080808080",
    "0xf8669d208fb507ea18f5fbdd3c205bfca7dfd1df3ed26a62b9579f77d6bd76d1b846f8440180a078efa97837320d7df692d2ef6c862cccbd5c7511a214c6f7842285cd71bc7f3aa0e6436a7d74e9438dc0a8d23f1b1bc90a44eb9c688f34e8254587b9d29a1bac5b",
  ],
  address: "0x0e192d382a36de7011f795acc4391cd302003606",
  balance: "0x0",
  codeHash: "0xe6436a7d74e9438dc0a8d23f1b1bc90a44eb9c688f34e8254587b9d29a1bac5b",
  nonce: "0x1",
  storageHash: "0x78efa97837320d7df692d2ef6c862cccbd5c7511a214c6f7842285cd71bc7f3a",
  storageProof: [
    {
      key: "0x35",
      proof: [
        "0xf90211a0adcf10b6e3d58d07c9dbd50f71dbe80943c45e49a567de387071a01fcbb74063a03570ecc329fe51f97759ba3c0c7e0b282451f814bbe0effad5d9f149be6cb9e0a00ad6efdf5a424b2df397e5f370a2b142c30f9b6bd2343c00eb40ef85a71b607ba012028a63c6837cc041207c365674049e9761898b4bbbe105bdb5545308fe59d2a079451fb051e961e86aa34688004e862a6ef13e966a24692f9ea755d1d060ecd0a03b91b336d588922ea1b53c3d4d10875bfd947c8731d0de139efe5c2288f8c3a7a09e858577e2fc9b0e78f7dde98dfb74df61c50d79e8dcda0c5c6ce5cf077a0041a079c52783d96f9c4f7eba2ec23e4cbb08892054440ce8960f70675d315c829182a0d6227538795825f5f19fc974968d1315a1c7e446acf133ef69975795de130476a0e7e89fbd9c2f4293979110b9095399a16d4ab84b12c87fd128601e858fcdaf10a060fb9375e4807ae8297e52176fa595cd45cbe4322dc32d1c7f66bf5d2b7861c4a094fa25ba2d4f5108e0bf64361b1d1ff41af4b3ae6cc6ed6ce5abba38c9bde5dea0344c220890226a7f6a22862842ae295583701e672ff106675f91aa190b30c985a08470149a7424d173dc0d006d5052bc27b182d0a294678610a78ef708a465d0c8a021f2807625fac0bd712e40ae1e92261d9f5187a9911dc711218eb0f079929326a0a3518d22ec245232de832326a66720935bafe389da163d0df86e5793ff56b51f80",
        "0xf90211a024c6adcb16cfc73b5ced1c13e77353d9357e442ed740d6860e1bb7c96d55cbf8a05d83f4e90c864b7614b6cfa734e16a415a416deb15695c4ba9f15c2779be0f03a0ea3df3ac78460e4832a67ee69392841fe288ab18929218990d91ef11ab615d74a0cd7527e7f5ebdfe40c58153076c8af558b20771c68a57a70b71973169df5f11aa01f33ab5fae04f6b53b0eeefccba983b3aa402c875cdd56eb79e97adca21321b0a04b2eb026028e75be7f8dbf86bf8ad46cc1c30fb3fbea1b5adf76fcd4db0644d4a0d34311a1c649aeaf2163889df22f24e94f133e2f6038d26a27be8ce123f85463a07bb795d7726d39cf454816ae827baea6cc1743350ca800593c2ebfbf3e3fc3a5a050780fef547342dfe85c9474979cb7340dff84a8933d3081b55618500db02786a049fafcf0d0e16c439cf9ba7d63e77c630738cb777f0c2c72eceb159ff381797ea0d3362f322f38a55c6cfe45175291b8d3aaf33ed07e5e15eb0d5d1dad4a66eb80a03a95b9812251738139f4a02b9ef062bc2de76f2761676b4bc908d3ff288774a6a0178bf636822aefd8ce92bb5f2e38c6f0d293ca918f22de3a60164ce49fe55cefa0d2bfa87a3fac1b402a0beb57ef934eed81ce463e9ace580b81e8aa4a4e4608fca06b1cfd5b1b2aa542e6d2e352f721257143f2b0986919b41bdd7dab79d830086fa0f7c0a8e67953ee9bac168fb31c2db7c8167be1fd46c356ca8331628a4ea1f17080",
        "0xf90211a04172743ddd656055735f0b1fa8ccb2a2f565d12686cab98d4edeaef10ad6c160a0de5b17ea20d1e58ee6809d90ce46e57ca6f28640c0dccfbdb9772779cb53b506a079083f20bbfb11fc81d7689bfbc223dc8dc073ad3c0a512e8fb49b176da36d58a0bcbe3cb2a67f65bd3df13fee5a95f1b8ce6d63908e17738949194f3ef8f49376a0ea365f9aa0d605893740085a4bc5014c28b90ad875a8d51a6dfbb12c5b6975d6a053b1f98609b8cba232559a03b14d426c218a9b73b5904c49776cb6246e2ead7ba0cb988f083eb01d28f6bf0ceb255b44a051220507f443195b16c29669b76b426ea07caceb8cf6d283faf2e7fbab8f317a048e4f8a0331f4e07f5e5e4e1092db6751a00d5b543dde2a824264b7ed8b850a575ad28e9edc306f45b5351737dd60f04907a011e6e71dc6c013b39cadbd1ad7a20a9e3015abdc5d67c03ee0a35885068e75faa079380fe941571ba90d9a7d3dc5a22c9e1a02a3f47707554ba4b9c88c7dbee43aa0c88873bb1a5c729cbd1f4db181e4e02cb29f8382617ee543dcbe6a966b67ae99a0e98af49fd4a7668100da5d5e5cbede272bcf6ee783b2274e891c694e5817c1eda0e351ca6f96a63e4f5ad8a380fce67a060ec28d249be449ce9f4939a75df5cf35a0c72f84c7e4b69a3a8af1957a48240eb1b14de2039292da58eb28d078eee9db46a0f9df2f6018da046e76e96e9fdbdb1cffa9b50a93436dca1031c32d98b2ba070180",
        "0xf8d18080a0e77b8f35c341c754128e712db22f46d89ed3917a06caaf445f902bdbd0dcc9bf80a0981e786909903204be256808cc99458e12196044f1b8ddc85ccc338ec52431baa02fac10cc69abc0f783910f9e93a56bcf28b0223af8cf33701b721768da9f95b880808080a053a2b5b5271b7099fff13d0f93eb97241a7a5f1dd8d08c5382b965d330ec1da88080a0e6ef0ab61a0687d4c4b8e1770b12c9180abfdcd7ee1850ccbfa034eb119a4acfa05e3e506b4d711aab559e22fd20e8f73bc0d8445366ec51918eade8ed453c563e8080",
        "0xed9f20bec1d3298408bb5afcfcd9c430549c5b31f8aa5c5848151c0a55f473c34d8c8b14e632f057fdefe27f4b2a",
      ],
      value: "0x14e632f057fdefe27f4b2a",
    },
    {
      key: "0xfadb25d1f9962f954239d296a910b38255e05ad6401d7155358c03448cb0a78b",
      proof: [
        "0xf90211a0adcf10b6e3d58d07c9dbd50f71dbe80943c45e49a567de387071a01fcbb74063a03570ecc329fe51f97759ba3c0c7e0b282451f814bbe0effad5d9f149be6cb9e0a00ad6efdf5a424b2df397e5f370a2b142c30f9b6bd2343c00eb40ef85a71b607ba012028a63c6837cc041207c365674049e9761898b4bbbe105bdb5545308fe59d2a079451fb051e961e86aa34688004e862a6ef13e966a24692f9ea755d1d060ecd0a03b91b336d588922ea1b53c3d4d10875bfd947c8731d0de139efe5c2288f8c3a7a09e858577e2fc9b0e78f7dde98dfb74df61c50d79e8dcda0c5c6ce5cf077a0041a079c52783d96f9c4f7eba2ec23e4cbb08892054440ce8960f70675d315c829182a0d6227538795825f5f19fc974968d1315a1c7e446acf133ef69975795de130476a0e7e89fbd9c2f4293979110b9095399a16d4ab84b12c87fd128601e858fcdaf10a060fb9375e4807ae8297e52176fa595cd45cbe4322dc32d1c7f66bf5d2b7861c4a094fa25ba2d4f5108e0bf64361b1d1ff41af4b3ae6cc6ed6ce5abba38c9bde5dea0344c220890226a7f6a22862842ae295583701e672ff106675f91aa190b30c985a08470149a7424d173dc0d006d5052bc27b182d0a294678610a78ef708a465d0c8a021f2807625fac0bd712e40ae1e92261d9f5187a9911dc711218eb0f079929326a0a3518d22ec245232de832326a66720935bafe389da163d0df86e5793ff56b51f80",
        "0xf90211a0e149e099534c98946435991c0e72947ff344edc739d1094e08958542b38d8c1aa06086d1c623abdb68fa1757447ba748aecbd58ab1cbb6b1412a7969d2dc04310aa03c5e11a3ba7da2d91414bb5daa570f532094e7772729408d1ddabbd45e7ebc94a0724ef91287ddbe27e515c3c6253e7a0408a83480ff39e6f30a4752732807da34a08ac3ce810d2eb9dcd359d9584b98a3d3728439bea864d7ee481deaf42c87c176a0789219eda5cd3ef1092e8a007c1b1743a097eef59ee0afb2e2d0bbd62907269ca0bdbfdb9370fd170f9557df62fd3ad38546e5241d6dcc1d7957998bd7f603f8a0a0d1fd3bf9821550da0a802f18d366ef8feb328b3aec9cd6f11f26dcd7b68706eda066fc700e056f1537d56b29bd0421aefa45a2bcf13c70af6f43fbd22f6c8aefd8a0cae9c5fa86a9b5ad1a9c97063224a7f93eecc8607c46d581bcefa07fd0efec78a030356f6e07c464b2b751978afa005323c120eb50c52abcd3a2a3fcc77359d1fea0430f0b5e768f2a9c0c40b0b5ab6145b8da007e54130e7f62ef8d23a21363a547a010925c5f3f03ea613f9204287c7ef8f2002604ee636ce944368b2bfb7caf9571a07831e8362ee50b927c398b560de5a42fe869e1f97240e5b7ff1f32364531e76da00e86a96dedb2243900f929487456adafea137639f4dceee38c7b8c1a2d6338b4a051789f6e56dd136c5c00eda996fbdf2bbf6c9fb682382a1f8f71d0f3b685fe2d80",
        "0xf90211a0766ccc83bf3f22291f484e1fbb0f1fce19e6fccd9c8d67ab6942e4ddfc127b37a004110f3a2e1716c901cf32aaecb35bb4a84806ec1e0640b932635e402cd7c50ba0037ae4d3b11ad901266d381712f923fbf10239decee8ff0472012a241765fdbaa035b815c4bdd296d49e19e343fad06b5cb8e5e986d16ac2f9506bb3ce56685cd8a087a5839a7648fd9f90068497bc2d744ee3d7f4380d9cd3dea17c4adf16cfa8bca0ec35df130877b2f534ae68dc79cbeaf5283f99c9306f7f88d1ce0832b5b4769fa067c9f4ca548f1e4758e04c0f9206d3fe9976223045a0e05e7683f6ab6de9b7f8a05bc31174066c2afbc4354df8b02ff743f2ae3ccf3a65de8f4e9890edab29ca55a047806e70de2eb2c157af231965c2998c4177954ac7109ab50ed31e3f1c715e28a0344ab12daea0ddce8c268d531552425d2151454a3d671d0d97ca1d28c929b66aa0548cecd8e0ec84224c16355fe5b1fca9477d9424665ad9c4457a744a4b8ef275a0504beb64d27d26e5c9960ba4e0122733f9fcc7e3bd4c958e759efcb21a736eeba03bcc3165a65675494aaae53892bbd3b2c2a9473f47c0eb046c7ab8f86d5bda9da0e8bcf86749c51460c409438c3d887fc2d7a23b0a9fe107a6ba98f73ea1f3694ea0af4e8121784d791dcad496ff790f9763417ad422c79853513921b197843a1968a052f971174ab5fa4b8f5f7a104865b445755f9278c40f72ea5766571f9967baad80",
        "0xf8f1a0bb14bf6b6e5bcad455bfd5dc102b977fbe275c4008ae4d7962a5d28e45364af9a0829366ca21e0333453faf9944254df4a76ea8418a55a693f455d0a2400c34ddda0613142bcb63bab484e1b10aa64be86b475c7946ddb492298d5df88419f1a8843a031e3a05cb0b578ccd6b597dc64971622edf35c13b4c49a0219be255459ac1ece80a01ce49796c37183c4df9c610c147f848e5bf4f5b4f6f4454ad012d86e418ad1e28080a0efd98db0897f4bdab80640994d1829201607d3ca0707a2418357db1152cfc603808080808080a091e1bbaf3de7e1c82c5190a64e4aea99974f3f188979bef1424e063fde57acc680",
        "0xec9f20da78781916367d84c348edc77b8ebc9cfd71fd863cace044038c52e91fe18b8a5a65b6eb1d05bf5d8548",
      ],
      value: "0x5a65b6eb1d05bf5d8548",
    },
    {
      key: "0x94bdf92e07ebba62cfaf974e78d7f7c514e919fef5003e8b9fab181d8d037cb4",
      proof: [
        "0xf90211a0adcf10b6e3d58d07c9dbd50f71dbe80943c45e49a567de387071a01fcbb74063a03570ecc329fe51f97759ba3c0c7e0b282451f814bbe0effad5d9f149be6cb9e0a00ad6efdf5a424b2df397e5f370a2b142c30f9b6bd2343c00eb40ef85a71b607ba012028a63c6837cc041207c365674049e9761898b4bbbe105bdb5545308fe59d2a079451fb051e961e86aa34688004e862a6ef13e966a24692f9ea755d1d060ecd0a03b91b336d588922ea1b53c3d4d10875bfd947c8731d0de139efe5c2288f8c3a7a09e858577e2fc9b0e78f7dde98dfb74df61c50d79e8dcda0c5c6ce5cf077a0041a079c52783d96f9c4f7eba2ec23e4cbb08892054440ce8960f70675d315c829182a0d6227538795825f5f19fc974968d1315a1c7e446acf133ef69975795de130476a0e7e89fbd9c2f4293979110b9095399a16d4ab84b12c87fd128601e858fcdaf10a060fb9375e4807ae8297e52176fa595cd45cbe4322dc32d1c7f66bf5d2b7861c4a094fa25ba2d4f5108e0bf64361b1d1ff41af4b3ae6cc6ed6ce5abba38c9bde5dea0344c220890226a7f6a22862842ae295583701e672ff106675f91aa190b30c985a08470149a7424d173dc0d006d5052bc27b182d0a294678610a78ef708a465d0c8a021f2807625fac0bd712e40ae1e92261d9f5187a9911dc711218eb0f079929326a0a3518d22ec245232de832326a66720935bafe389da163d0df86e5793ff56b51f80",
        "0xf90211a00fdf80d2d0090eb82ec4c43b99cee1d6c7937abf02561c6bf86df7cae4db7842a0aa134fbf606d114df242a85712a5c52eccb26022c3186daadec147daeea8fd1fa0ea9d3b427b9be8c89e0fddcafb691376d2db0075e6b7ad471cddc8fd2fd99059a04cf0ba4c66b97972b9267070ebb0c0d716fab709519ddb261a184df5f5ad6cfca0a780d95b98c2bb7241b7b47e1ace67eccff60a011e1114ff1d015fd10629a3b4a0a6521b587272faaf3854d3ceb64652824b9774b468573e633cafe5fb2ac3c26ca036795ea92785c8db14cdf4c26b691496bcdd6e3c1a371eb6450d57967211d5eaa074b3f294f8961d38078f6fa7c87cfd788d6d0b0da20fb8f7f2d055d7c200f9ffa0b6b783a57e53a4680d9d885ab19369452d40905f75d7ebd37f62ac613f0b5b96a0d05bfc72e5ad40fc18eb02d31905eeb386c1d8bb68463a3a074824f8eda1795da0cad0b99a605e568d3de4b7af2fe4f09389e98eb7c511ba48c405b9183db4e297a0b3dc5ab039a85342dfd0c37ea1bec21e404a14e7523d08091b01dbf57e652396a0033fcac55bb3ea9dcf6f6e5c44244486f522bddf9cf2431b9c35654e3f4ba5c3a04ea7c06d79af37aeeb31b449527e8cd7440d37bc1dd083fe7439a6ceb133fc91a0c9016c939282eea9a8e941921cfe790b95eea370c6bf91a0095036eb89a8a475a0cb622d62277651cb3aa5e710a5e1af1744bc2c3fa662b6e9266e483536cfc92c80",
        "0xf90211a04e3dcd6eface47b3b0ce5a0afcd5d9329b49d796404a5b1b75f6ce049b614beda0423e71e06c6e1a24165d23e5eba5dd272ab8d7884178651fa78893e8a8747961a02e618d5e08a6233ff1ffc92c8832c68629a379a6e43be8ee3c47dbec78c5adf7a07d88349566acb05b78e03314563042aec266a56aa1080eae771fee65f5ed07eda032de752e9b536b6dac77e90a84bb071d58e6f73818ee0c57f03941214d660f59a0e9f976402b64702d7998539cc7ab73f0983b1a39afc001d1cb55e497769c87e0a061b9a8b43c02cfed9e9ed700802d8a024ad6b79ff6fd162ed8697fc1bb6ca935a0a6f5d4176a252b41fa6fd294605039399fda9a863a4f77797343bac3613e5201a0a82574239cc3a950a7425e9995e1a5650cdf82bc248700f937ee4e0916c12e9aa0f9ab6da13f333efe35bbf9de335c9919a9e13376a7113a138a0da2c4e81efa90a053f964bccc2516746141a48c61bafcbaf4e34ef394d1092b05a87b8aaa6d7d46a050d793e90fd62c652961aa38ad956cebda1d5c5a2a05e0ff08deb624e5321f08a01167899d6e68bda5dc30b0007e939f2abb2bffb0902fbbf385ed399ed9257072a09e6a989e7ef787fd932a73806acb2e27ba27f63776d458ef355c9618f9b04b2ea041681b81ef5bed69c34f6145712e19645ddcefa86b191002a22c2990537e4278a0d32dd63871a59497278e8a7215a610bcf0e9811b55f646591c2699666f92aae280",
        "0xf9011180a01dac31a308d959e831220976def86072729e4bdf7953753b85783c04c1d3a8d4a008b8f137b30bb0507da54e8caa71e63e7d917266131068ebdcd07267d1465557a012693c298036201468c54d4fd4c3401f30f43f4a4b6570532d2588e8d1d466d480a06e5f54a05e5fd6966fca6ed56e3ff92e0bba789205035d97794932330d57a7c6a069178ab4415a982522d2ac4ae5d6f4e2813402e377252337687aabb0bf8df5098080a057ffe71aaeb49a71ebc16a3ccfc82579855e416a1baf8bbbbf55274b283dbaeaa0bdf7f1546a945a8fbb0301032196a731d89dfa24dfa31632da312c3d24e7777e808080a0031dab5f2b29c375b51a8af7d4c8d211b6bcd5bb1f730d499ff2a8a2bf79dcd28080",
        "0xf851a02230d334f4789c3d5705de8039443a4858c63aa2564e51da5cf64b59e1743ac2808080808080808080a0a2d25b075e2bada6d2efc8f765d98c371789f6db72ce90aacdac1091d37826ad808080808080",
        "0xea9e3dc33e471a88582c54541d42c3ed250ddb7d84713a00bfb83825f2f153128a891041f2d50fcba658d1",
      ],
      value: "0x1041f2d50fcba658d1",
    },
    {
      key: "0xf6d04bbe1a75429862aa97cc198c639a5559580c07ae94016a2b25986f2e3abd",
      proof: [
        "0xf90211a0adcf10b6e3d58d07c9dbd50f71dbe80943c45e49a567de387071a01fcbb74063a03570ecc329fe51f97759ba3c0c7e0b282451f814bbe0effad5d9f149be6cb9e0a00ad6efdf5a424b2df397e5f370a2b142c30f9b6bd2343c00eb40ef85a71b607ba012028a63c6837cc041207c365674049e9761898b4bbbe105bdb5545308fe59d2a079451fb051e961e86aa34688004e862a6ef13e966a24692f9ea755d1d060ecd0a03b91b336d588922ea1b53c3d4d10875bfd947c8731d0de139efe5c2288f8c3a7a09e858577e2fc9b0e78f7dde98dfb74df61c50d79e8dcda0c5c6ce5cf077a0041a079c52783d96f9c4f7eba2ec23e4cbb08892054440ce8960f70675d315c829182a0d6227538795825f5f19fc974968d1315a1c7e446acf133ef69975795de130476a0e7e89fbd9c2f4293979110b9095399a16d4ab84b12c87fd128601e858fcdaf10a060fb9375e4807ae8297e52176fa595cd45cbe4322dc32d1c7f66bf5d2b7861c4a094fa25ba2d4f5108e0bf64361b1d1ff41af4b3ae6cc6ed6ce5abba38c9bde5dea0344c220890226a7f6a22862842ae295583701e672ff106675f91aa190b30c985a08470149a7424d173dc0d006d5052bc27b182d0a294678610a78ef708a465d0c8a021f2807625fac0bd712e40ae1e92261d9f5187a9911dc711218eb0f079929326a0a3518d22ec245232de832326a66720935bafe389da163d0df86e5793ff56b51f80",
        "0xf90211a0118cc751bf43671c16ecb7860e168560b93f8e5e385e9188f474b1b973e9a522a0a06f117cb4694f752c04f31aacf39ff1f206419909faf3db0b8aa0edbce515aaa0cc25aef8726f8be467e936754948e24ae8b5198d6b176e5e68e151ab58c0593aa0a0d196c490190571e06806e8e963ab35de840a21bdb9c30379387eda0dc10feca08cfff28be6bd10e0e05bce4d3d15470e8d791dee52bf877c2ea38c951001405ca08a4936471490ede1e9e1d97e3e31f5cb788f2eefe3a9b62ccca2ee42197068b0a0ea26c3b36dd67bdc5b78ae72221e8833d5cf6b7eaf819fea38a0c31ff4fe539fa073fbaf67ef91032a189cefb733ac988193e499095b8f73c1bb517aca44f63c85a018eb25e47abda3b080534cd961f1f7d62eef21dced6023a7b6ba31a5016ab0d8a0671d2b0a704b9841e96bd3744123339b5210fe325883908f71c421a2707a0a7ba052998892961afca2f85378b3a308482754073f68f2d6ac5a78e338b2f998abc2a037c4a48d34dfbcaaf7a381f9b87a4c5944c419442a25b90baaa26058475c2104a075b2d194abf520da7d8a18a65028a31c71002ec0927779a7c874194a473c4c50a03d13863527da58729e071f630bc4546306b39d632f4676230308b6976c319595a0f943e627c9d2107d9362b33d8c7bdadf85fe2164f3aa32985c88822a70005781a0b88716a1cdf399f0a16d7b9b5364c3a3a8143b892819412ea4a30a0d7f4c72fb80",
        "0xf90211a0f9de8fdeb0db2790264c3305b0ef56121eccd34cf6d213e67797d74bd0e3a8e0a020b06248afb312c63efeb37b053ea2d10dc8fc6c04e1f9d2865a37fae38adbdfa0e620bc5ecbe3f5f549ead99001a2d31e67be56c3adf5410af67b7f9a52af554ca01606418c2303a7086d7d6ea05e1c409e3a7bd0be87fc349043a632fd984c5d28a0d66b1cf5c07b68187c4f6944ce305eaa379e3da922f1145a3461ecbe7aec946aa08cef274300167066621cb05b53e7ff155f3fd13257a0059fff1699c196e9bb00a0da9d2674797e86b3cb04f2d1558d45d1c2072e79659012c20e8b645a8b3c49c6a000359366c3adb5b6db50f6b630e1bea36e8f9aaad45a458865d7ffdbc53e5ee3a00541bf124167291aeefc0d1b6ca46ea6419cbe8a18709d13952a9926a6dee203a072e772c1c4ac73d4a1b13c5c4e566053993f84b8520c4666efa4dca622ec80daa0cac77ae55d96240bbd9a0cac4e92e2fcbbe67a6e179dfee72b381b97945d596ea0a2ef4ac4e36a53745d25983a3207044dcb37bfc25bc357ec7ee38f2624e775d4a0f5c78df99ccab47e3151c7e40945313ab9538ce9bd44a8a6663c95c96299b428a07e8b49bb478d03ca0218e34ccb18b66c6763c11f60c8513f860c9123da9ec986a02a39ca620e3c20ed8f0a5835531f96e3372b0131eb1a3c0dcd3e13bcc6613568a0de2bf803cdb40c6f58f79ad985e5c20c8801ce200d6a2b0ab7d404745cef9c0580",
        "0xf9013180a028f507d0810579e9abcd60f2a7230dae8b6879d4dcb89b9478574d5bf0a85231a05e8f0ce738d069bd0a4d78dc1150ae04e6a71f01641cbc7621546cbd7fffe5e0a06d8c37f75990a83b0bb751436bb5128d9539c2deb5d11e47cb40b146c3b7dd99a03db8c61a3457bf0713ac51218c6de8fedf488696bf4c93807d466c168712650aa0712e8773e32a8cb6a6886417b41e3f60630302727a1d19e84cd710f42e22e3dca04eebf08e1151c04c6031acd4187a7b102477cf028b8939f3bf8e1245807e2faf80808080a05f39e4fc7ed13c41c5c88e4a4dc524582c9f703b25e5285ce8fc6d9b25bf3a1ea05f00f29d79edb442f6ce7cfe40fd52bb9d5b313b1990692af460d39238ff785a80a06598322c3d2d1565e221c21132115261d18594153300599d53642a31edb2caca8080",
      ],
      value: "0x0",
    },
  ],
};

// two ethereum accounts with non-zero FST balance
const voters = [
  "0x2eb212BDD6EcbfB8D07840fE6863af31dbDcEabf",
  "0x673d86d7fba60d6586d6bdd8721daccc0412efdc",
];

// signatures of the above two accounts to vote yes (non-malleable due to domain separator)
const signatures = [
  "0x8658ac3d8dc653471461a5bf0fa3f53ae4fd04160c1d857be1829d9cd1df4e792902a1b83c01dcd1349e8b4758af5e91aa2a849bf588460903d00b7a6e5198111b",
  "0xfc562c43b2c511015a67ce343dfc26e2af3871960f7fd7f08dac9184c964b6b3381c5301f598ef6d1faab716178db7b74252380d6218f35125aa9108fc7185a81b",
];

const encodeProof = (proof: string[]) => {
  return ethers.utils.RLP.encode(proof.map(p => ethers.utils.RLP.decode(p) as unknown));
};

const fromNumber = (x: ethers.BigNumberish) => {
  const y = ethers.BigNumber.from(x);
  if (y.eq(0)) return "0x";
  return y.toHexString();
};

// useful to analyze a patricia merkle proof
/*
const logProof = (proof: string): void => {
  console.log(
    Object.fromEntries(
      ethers.utils.RLP.decode(proof).map((x: unknown) => [
        ethers.utils.keccak256(ethers.utils.RLP.encode(x)),
        x,
      ]),
    ),
  );
};
*/

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const encodeBlockHeader = (block: any) => {
  /* eslint-disable @typescript-eslint/no-unsafe-member-access */
  return ethers.utils.RLP.encode([
    block.parentHash,
    block.sha3Uncles,
    block.miner,
    block.stateRoot,
    block.transactionsRoot,
    block.receiptsRoot,
    block.logsBloom,
    fromNumber(block.difficulty),
    fromNumber(block.number),
    fromNumber(block.gasLimit),
    fromNumber(block.gasUsed),
    fromNumber(block.timestamp),
    block.extraData,
    block.mixHash,
    block.nonce,
    fromNumber(block.baseFeePerGas),
  ]);
  /* eslint-enable @typescript-eslint/no-unsafe-member-access */
};

const makeVote = (i: number) => {
  return {
    voter: voters[i],
    support: true,
    signature: signatures[i],
    proof: encodeProof(proofs.storageProof[i + 1].proof),
  };
};

describe("Voting test", () => {
  async function deployVotingFixture() {
    const [user] = await hEthers.getSigners();
    // use unique owner to deploy on fixed address
    const owner = (await hEthers.getSigners())[101];

    const hashNFT = await new HashNFT__factory(owner).deploy("FSV");
    const voting = await new VotingTest__factory(owner).deploy(
      hashNFT.address,
      fstAddress,
      fstMappingSlot,
      fstTotalSupplySlot,
      owner.address,
    );
    await voting.setMockBlockHash(block.hash);

    return {
      owner,
      user,
      hashNFT,
      voting,
    };
  }

  it("Can propose vote", async () => {
    const {voting} = await loadFixture(deployVotingFixture);

    const blockHeader = encodeBlockHeader(block);

    await expect(
      voting.proposeVote(
        "Test",
        "Test vote",
        [],
        1,
        blockHeader,
        encodeProof(proofs.accountProof),
        encodeProof(proofs.storageProof[0].proof),
      ),
    ).to.emit(voting, "ProposalCreated");
  });

  it("Can vote", async () => {
    const {voting} = await loadFixture(deployVotingFixture);

    const blockHeader = encodeBlockHeader(block);

    await voting.proposeVote(
      "Test",
      "Test vote",
      [],
      1,
      blockHeader,
      encodeProof(proofs.accountProof),
      encodeProof(proofs.storageProof[0].proof),
    );

    await expect(voting.voteBatch(0, [makeVote(0), makeVote(1)])).to.emit(voting, "VoteCasted");
  });

  it("Can't vote twice", async () => {
    const {voting} = await loadFixture(deployVotingFixture);

    const blockHeader = encodeBlockHeader(block);

    await voting.proposeVote(
      "Test",
      "Test vote",
      [],
      1,
      blockHeader,
      encodeProof(proofs.accountProof),
      encodeProof(proofs.storageProof[0].proof),
    );

    await voting.voteBatch(0, [makeVote(0), makeVote(1)]);

    await expect(voting.voteBatch(0, [makeVote(0), makeVote(1)])).to.be.reverted;
  });

  it("Can't vote without non-zero balance", async () => {
    const {user, voting} = await loadFixture(deployVotingFixture);

    const blockHeader = encodeBlockHeader(block);

    await voting.proposeVote(
      "Test",
      "Test vote",
      [],
      1,
      blockHeader,
      encodeProof(proofs.accountProof),
      encodeProof(proofs.storageProof[0].proof),
    );

    const signature = await signVote(voting, 0, true, user);

    await expect(
      voting.voteBatch(0, [
        {
          voter: user.address,
          support: true,
          signature,
          proof: encodeProof(proofs.storageProof[3].proof),
        },
      ]),
    ).to.be.revertedWith("no balance");
  });
});
